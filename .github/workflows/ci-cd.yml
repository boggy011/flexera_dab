# CI/CD Pipeline for DataLib
# Handles testing, building, and deploying across environments
# Uses Service Principal (OAuth) authentication for all environments

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - 'feature/**'
      - 'release/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - prd

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ==========================================================================
  # Test Job - Runs on all branches
  # ==========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run linting
        run: |
          ruff check src/
          black --check src/
      
      - name: Run type checking
        run: |
          mypy src/datalib --ignore-missing-imports
      
      - name: Run unit tests
        run: |
          pytest tests/ -v --cov=datalib --cov-report=xml --cov-report=html
      
      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # ==========================================================================
  # Build Job - Runs on main and release branches
  # ==========================================================================
  build:
    name: Build Wheel
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')
    
    outputs:
      wheel_name: ${{ steps.build.outputs.wheel_name }}
      version: ${{ steps.build.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for versioning
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip build wheel
      
      - name: Determine environment and version
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=qa" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/heads/release/* ]]; then
            echo "environment=prd" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi
          
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          BUILD_NUMBER="${GITHUB_RUN_NUMBER}"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
      
      - name: Build wheel
        id: build
        run: |
          chmod +x ./scripts/build_wheel.sh
          ./scripts/build_wheel.sh ${{ steps.env.outputs.environment }} \
            ${{ steps.env.outputs.branch }} \
            ${{ steps.env.outputs.build_number }}
          
          # Get wheel info
          WHEEL_FILE=$(ls dist/*.whl)
          WHEEL_NAME=$(basename $WHEEL_FILE)
          VERSION=$(grep "version=" dist/version_info.txt | cut -d'=' -f2)
          
          echo "wheel_name=$WHEEL_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ steps.build.outputs.version }}
          path: dist/
          retention-days: 30

  # ==========================================================================
  # Deploy to QA - Runs when main is updated
  # ==========================================================================
  deploy-qa:
    name: Deploy to QA
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: qa
    
    env:
      # Service Principal authentication for QA (from GitHub Secrets)
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_QA }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID_QA }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET_QA }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: wheel-${{ needs.build.outputs.version }}
          path: dist/
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Databricks CLI
        run: |
          pip install databricks-cli
      
      - name: Load environment configuration
        run: |
          # Source non-sensitive config (catalog, paths, cluster settings)
          # Secrets are already set via env: block above
          source configs/environments/qa.env
          
          # Export for subsequent steps
          echo "CATALOG_NAME=$CATALOG_NAME" >> $GITHUB_ENV
          echo "LANDING_ZONE_PATH=$LANDING_ZONE_PATH" >> $GITHUB_ENV
          echo "JOB_CLUSTER_NODE_TYPE=$JOB_CLUSTER_NODE_TYPE" >> $GITHUB_ENV
          echo "JOB_CLUSTER_NUM_WORKERS=$JOB_CLUSTER_NUM_WORKERS" >> $GITHUB_ENV
      
      - name: Validate bundle
        run: |
          databricks bundle validate -t qa
      
      - name: Deploy to QA
        run: |
          databricks bundle deploy -t qa
      
      - name: Run smoke test
        run: |
          # Trigger a test job run
          databricks bundle run -t qa bronze_customer_ingestion || true

  # ==========================================================================
  # Deploy to Production - Manual trigger or release branch
  # ==========================================================================
  deploy-prd:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, deploy-qa]
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prd') ||
      startsWith(github.ref, 'refs/heads/release/')
    environment: production
    
    env:
      # Service Principal authentication for Production (from GitHub Secrets)
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_PRD }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID_PRD }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET_PRD }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: wheel-${{ needs.build.outputs.version }}
          path: dist/
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Databricks CLI
        run: |
          pip install databricks-cli
      
      - name: Load environment configuration
        run: |
          # Source non-sensitive config (catalog, paths, cluster settings)
          # Secrets are already set via env: block above
          source configs/environments/prd.env
          
          # Export for subsequent steps
          echo "CATALOG_NAME=$CATALOG_NAME" >> $GITHUB_ENV
          echo "LANDING_ZONE_PATH=$LANDING_ZONE_PATH" >> $GITHUB_ENV
          echo "JOB_CLUSTER_NODE_TYPE=$JOB_CLUSTER_NODE_TYPE" >> $GITHUB_ENV
          echo "JOB_CLUSTER_NUM_WORKERS=$JOB_CLUSTER_NUM_WORKERS" >> $GITHUB_ENV
          echo "DATABRICKS_SP_NAME=$DATABRICKS_SP_NAME" >> $GITHUB_ENV
      
      - name: Promote wheel to production
        run: |
          chmod +x ./scripts/promote_wheel.sh
          ./scripts/promote_wheel.sh qa prd
      
      - name: Validate bundle
        run: |
          databricks bundle validate -t prd
      
      - name: Deploy to Production
        run: |
          databricks bundle deploy -t prd
      
      - name: Create release tag
        run: |
          VERSION=$(grep "version=" dist/version_info.txt | cut -d'=' -f2)
          git tag "v$VERSION"
          git push origin "v$VERSION"

  # ==========================================================================
  # Deploy to Dev - Feature branches (manual)
  # ==========================================================================
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: test
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.environment == 'dev'
    environment: development
    
    env:
      # Service Principal authentication for Dev (from GitHub Secrets)
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_DEV }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID_DEV }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET_DEV }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install databricks-cli build wheel
      
      - name: Load environment configuration
        run: |
          # Source non-sensitive config (catalog, paths, cluster settings)
          # Secrets are already set via env: block above
          source configs/environments/dev.env
          
          # Export for subsequent steps
          echo "CATALOG_NAME=$CATALOG_NAME" >> $GITHUB_ENV
          echo "LANDING_ZONE_PATH=$LANDING_ZONE_PATH" >> $GITHUB_ENV
          echo "JOB_CLUSTER_NODE_TYPE=$JOB_CLUSTER_NODE_TYPE" >> $GITHUB_ENV
          echo "JOB_CLUSTER_NUM_WORKERS=$JOB_CLUSTER_NUM_WORKERS" >> $GITHUB_ENV
      
      - name: Build wheel for dev
        run: |
          chmod +x ./scripts/build_wheel.sh
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          ./scripts/build_wheel.sh dev "$BRANCH_NAME" "$GITHUB_RUN_NUMBER"
      
      - name: Deploy to Dev
        run: |
          databricks bundle deploy -t dev
