# Orders Cleansing Pipeline - Silver Layer
# Cleanses and enriches order data

pipeline:
  name: orders_cleansed
  layer: silver
  description: "Cleanse, validate, and enrich orders data from bronze layer"
  version: "1.0.0"
  owner: "data-engineering-team"
  tags:
    domain: "sales"
    criticality: "high"
    schedule: "hourly"

source:
  type: table
  catalog: "${CATALOG_NAME:main}"
  schema: "bronze"
  table: "orders_raw"

target:
  catalog: "${CATALOG_NAME:main}"
  schema: "silver"
  table: "orders_cleansed"
  mode: "merge"
  format: "delta"
  merge_keys:
    - "order_id"
  partition_by:
    - "order_year"
    - "order_month"
  options:
    optimize: true

processing:
  mode: "incremental"
  watermark_column: "ingestion_timestamp"

transformations:
  - type: filter_rows
    params:
      condition: "order_id IS NOT NULL AND customer_id IS NOT NULL"
  
  - type: deduplicate
    params:
      subset:
        - "order_id"
      keep: "last"
      order_by:
        - "ingestion_timestamp"
  
  - type: cast_columns
    params:
      column_types:
        order_id: "string"
        customer_id: "string"
        order_amount: "decimal(18,2)"
        tax_amount: "decimal(18,2)"
        discount_amount: "decimal(18,2)"
        order_quantity: "integer"
  
  - type: fill_nulls
    params:
      fill_values:
        tax_amount: 0.0
        discount_amount: 0.0
        shipping_cost: 0.0
  
  - type: add_derived_column
    params:
      column_name: "order_year"
      expression: "year(order_timestamp)"
  
  - type: add_derived_column
    params:
      column_name: "order_month"
      expression: "month(order_timestamp)"
  
  - type: add_derived_column
    params:
      column_name: "order_day_of_week"
      expression: "dayofweek(order_timestamp)"
  
  - type: add_derived_column
    params:
      column_name: "total_amount"
      expression: "order_amount + tax_amount + shipping_cost - discount_amount"
  
  - type: add_derived_column
    params:
      column_name: "is_weekend_order"
      expression: "dayofweek(order_timestamp) IN (1, 7)"
  
  - type: add_timestamp
    params:
      column_name: "processed_timestamp"

quality:
  enabled: true
  fail_on_error: true
  checks:
    - type: not_null
      name: "order_id_not_null"
      column: "order_id"
    
    - type: not_null
      name: "customer_id_not_null"
      column: "customer_id"
    
    - type: unique
      name: "order_id_unique"
      column: "order_id"
    
    - type: range
      name: "order_amount_valid"
      column: "order_amount"
      min: 0.01
      max: 1000000
    
    - type: custom
      name: "total_amount_calculated_correctly"
      expression: "abs(total_amount - (order_amount + tax_amount + shipping_cost - discount_amount)) < 0.01"

parameters:
  source_layer: "bronze"
  data_classification: "internal"
